pipeline {
    agent any
    parameters {
	string(name: "REMOTE_USERNAME",
	       defaultValue: "",
	       description: "remote server username"
    )           
    string(name: "REMOTE_PASSWD",
	       defaultValue: "",
	       description: "remote server passwd"
    )           
    }
    stages {
        stage('deploy app and reports') {
            steps {
               script {
               //withCredentials ([sshUserPrivateKey(credentialsId: 'oracle', keyFileVariable: 'identity', passphraseVariable: '', usernameVariable: 'oracle')]) {
               def remote = [:]
               remote.name = "Buhnyuy-web_server2"
               remote.host = "54.221.128.14"
               remote.allowAnyHosts = true
               remote.user = "${REMOTE_USERNAME}"
               remote.password = "${REMOTE_PASSWD}"
               remote.pty = true
               //remote.identityFile = identity
               sh "pwd" 
               sh "ls -la Docker-compose-dir "
               sshPut remote: remote, from: '/var/lib/jenkins/workspace/DevRelease2/Docker-compose-dir/petclinic', into: "/home/${REMOTE_USERNAME}/"
               sshCommand remote: remote, command: "sudo yum install docker -y", sudo: true
               sshCommand remote: remote, command: "sudo systemctl start docker", sudo: true
               sshCommand remote: remote, command: "sudo systemctl enable docker", sudo: true
               sshCommand remote: remote, command: "sudo usermod -aG docker cloud_user", sudo: true
               sshCommand remote: remote,command: "sudo curl -L https://github.com/docker/compose/releases/latest/download/docker-compose-\$(uname -s)-\$(uname -m) -o /usr/local/bin/docker-compose", sudo: true
               sshCommand remote: remote, command: "sudo chmod +x /usr/local/bin/docker-compose", sudo: true
               }
            }
        }
        stage('deploy springpetclinic') {
            steps {
              script {
              def remote = [:]
              remote.name = "Buhnyuy-web_server2"
              remote.host = "54.221.128.14"
              remote.allowAnyHosts = true
              remote.user = "${REMOTE_USERNAME}"
              remote.password = "${REMOTE_PASSWD}"
              //remote.identityFile = identity
              sshCommand remote: remote, command: "docker-compose -f petclinic/docker-compose.yml up -d"
              }
            }
        }
  }
}